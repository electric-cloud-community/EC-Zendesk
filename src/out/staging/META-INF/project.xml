<exportedData version="69" buildLabel="build_main_89270_2015.04.16_07:48:51" buildVersion="5.4.0.89270" passkey="5988fd40f08f691b7b3605f17301cfc761659b8f">
  <exportPath>/projects/EC-Zendesk</exportPath>
  <project>
    <projectName>EC-Zendesk</projectName>
    <description>&lt;html>
Plugin to interact with Zendesk. Originally developed for the &lt;a html="http://citrixapps.challengepost.com/submissions">Citrix Hackathon&lt;/a>.&lt;br/>
Nikhil and Laurent won "&lt;b>Best in Show&lt;/b>" at the Citrix Synergy 2015 conference for this project.&lt;/html></description>
    <resourceName />
    <tracked>0</tracked>
    <workspaceName />
    <propertySheet>
      <tracked>0</tracked>
      <property>
        <propertyName>ui_forms</propertyName>
        <tracked>0</tracked>
        <propertySheet>
          <tracked>0</tracked>
          <property>
            <propertyName>createConfigForm</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>&lt;editor>
    &lt;formElement>
        &lt;type>entry&lt;/type>
        &lt;label>Configuration Name:&lt;/label>
        &lt;property>config&lt;/property>
        &lt;value>&lt;/value>
        &lt;required>1&lt;/required>
    &lt;/formElement>
    &lt;formElement>
        &lt;type>credential&lt;/type>
        &lt;label>Login as:&lt;/label>
        &lt;property>credential&lt;/property>
        &lt;value>&lt;/value>
        &lt;required>0&lt;/required>
    &lt;/formElement>
&lt;/editor></value>
          </property>
          <property>
            <propertyName>editConfigForm</propertyName>
            <counter>0</counter>
            <expandable>1</expandable>
            <tracked>0</tracked>
            <value>&lt;editor>
        &lt;formElement>
        &lt;type>credential&lt;/type>
        &lt;label>Login as:&lt;/label>
        &lt;property>credential&lt;/property>
        &lt;value>&lt;/value>
        &lt;required>0&lt;/required>
    &lt;/formElement>
&lt;/editor></value>
          </property>
        </propertySheet>
      </property>
      <property>
        <propertyName>configureCredentials</propertyName>
        <counter>0</counter>
        <description />
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>1</value>
      </property>
      <property>
        <propertyName>ec_visibility</propertyName>
        <counter>0</counter>
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>pickListOnly</value>
      </property>
      <property>
        <propertyName>help</propertyName>
        <counter>0</counter>
        <description />
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

&lt;html xmlns="http://www.w3.org/1999/xhtml">
&lt;head>
    &lt;meta content="text/html; charset=us-ascii" http-equiv="content-type" />
    &lt;title>EC-Zendesk Plugin&lt;/title>
    &lt;link rel="stylesheet" href= "../../plugins/EC-Zendesk-1.3.0.136/pluginhelp.css" type="text/css" media= "screen" />
&lt;/head>

&lt;body>
    &lt;div class="help">
        &lt;h1>EC-Zendesk&lt;/h1>
		&lt;p>Plugin Version 1.3.0.136&lt;/p>
        &lt;hr style="margin-left: -10px; margin-top: 10px; height: 1px; width: 100%; color: #5981BD;" noshade="noshade" />

        &lt;p>EC-Zendesk is a collection of procedures to help you
interact with Zendesk.&lt;/p>
		&lt;p>&lt;b>Note:&lt;/b> this plugin was part of the bundle who helped Laurent Rochette and Nikhil Vaze won "Best in Show" at the Citrix Synergy 2015 conference.&lt;/p>

		&lt;h2>ElectricFlow Integration to Zendesk&lt;/h2>

		&lt;p>The plugin interacts with the Zendesk REST API. It is tied at this moment with the support schema for Electric Cloud. This is not intended as a generic Zendesk connector.&lt;/p>

		&lt;h1>Plugin Procedures&lt;/h1>

	    &lt;p>
	        IMPORTANT: For all parameter descriptions below, required
	        parameters are shown in &lt;span class="required">bold
	        italics&lt;/span>.
	    &lt;/p>

	    &lt;div id="CreateConfiguration">&lt;a name="CreateConfiguration" id="CreateConfiguration">&lt;/a>
    
    	&lt;h2>Plugin Configuration&lt;/h2>

        &lt;p>
        Plugin configurations are sets of parameters that apply
        across some or all of the plugin's procedures. They are
        intended to reduce repetition of common values, create
        predefined sets of parameters for end users, and to
        securely store credentials where needed. Each configuration
        is given a unique name that is entered in designated
        parameters on procedures that use them.&lt;br />
         Plugin configurations are created by going to the Electric
        Commander "Administration" tab, then to the "Plugins"
        sub-tab. On the right side of the line for the specific
        plugin, there is a "Configure" link which will open the
        Configuration page.
    	&lt;/p>

	    &lt;table class="grid">
	        &lt;thead>
	            &lt;tr>
	                &lt;th>Parameter&lt;/th>

	                &lt;th>Description&lt;/th>
	            &lt;/tr>
	        &lt;/thead>

	        &lt;tbody>
	            &lt;tr>
	                &lt;td class="required">Configuration Name&lt;/td>
	                &lt;td>Provide a unique name for the configuration.
	                (Required)&lt;/td>
	            &lt;/tr>
	            &lt;tr>
	                &lt;td class="required">User Name&lt;/td>
	                &lt;td>Provide the user login ID. Remember that login
	                IDs are case sensitive. (Required)&lt;/td>
	            &lt;/tr>
	            &lt;tr>
	                &lt;td class="required">Password&lt;/td>
	                &lt;td>Provide the user-specified password.
	                (Required)&lt;/td>
	            &lt;/tr>
	        &lt;/tbody>
    	&lt;/table>
    	&lt;img src="../../plugins/EC-Zendesk/images/help/configuration.png" alt="form" border="1"/>&lt;/div>

    	&lt;h2>createTicket&lt;/h2>

    	&lt;p>This procedure is used to open a new Zendesk ticket. It is called
    	automatically by &lt;a href="/commander/pages/EC-Support/help">EC-Support&lt;/a> 
    	plugins and is not designed to be used directly but nothing prevents 
    	you to encapsulate it in your own process if you so desire.&lt;/p>

	&lt;/div>
&lt;/body>
&lt;/html></value>
      </property>
      <property>
        <propertyName>pluginBuildNumber</propertyName>
        <counter>0</counter>
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>136</value>
      </property>
      <property>
        <propertyName>promoteAction</propertyName>
        <counter>0</counter>
        <description />
        <expandable>0</expandable>
        <tracked>0</tracked>
        <value># upgrade action
if ($upgradeAction eq "upgrade") {
    my $query = $commander->newBatch();
    my $newcfg = $query->getProperty(
        "/plugins/$pluginName/project/plugin_cfgs");
    my $oldcfgs = $query->getProperty(
        "/plugins/$otherPluginName/project/plugin_cfgs");
	my $creds = $query->getCredentials("\$[/plugins/$otherPluginName]");

	local $self->{abortOnError} = 0;
    $query->submit();

    # if new plugin does not already have cfgs
    if ($query->findvalue($newcfg,"code") eq "NoSuchProperty") {
        # if old cfg has some cfgs to copy
        if ($query->findvalue($oldcfgs,"code") ne "NoSuchProperty") {
            $batch->clone({
                path => "/plugins/$otherPluginName/project/plugin_cfgs",
                cloneName => "/plugins/$pluginName/project/plugin_cfgs"
            });
        }
    }
	
	# Copy configuration credentials and attach them to the appropriate steps
    my $nodes = $query->find($creds);
    if ($nodes) {
        my @nodes = $nodes->findnodes("credential/credentialName");
        for (@nodes) {
            my $cred = $_->string_value;

            # Clone the credential
            $batch->clone({
                path => "/plugins/$otherPluginName/project/credentials/$cred",
                cloneName => "/plugins/$pluginName/project/credentials/$cred"
            });

            # Make sure the credential has an ACL entry for the new project principal
            my $xpath = $commander->getAclEntry("user", "project: $pluginName", {
                projectName => $otherPluginName,
                credentialName => $cred
            });
            if ($xpath->findvalue("//code") eq "NoSuchAclEntry") {
                $batch->deleteAclEntry("user", "project: $otherPluginName", {
                    projectName => $pluginName,
                    credentialName => $cred
                });
                $batch->createAclEntry("user", "project: $pluginName", {
                    projectName => $pluginName,
                    credentialName => $cred,
                    readPrivilege => "allow",
                    modifyPrivilege => "allow",
                    executePrivilege => "allow",
                    changePermissionsPrivilege => "allow"
                });
            }

           # Attach the credential to the appropriate steps
            $batch->attachCredential("\$[/plugins/$pluginName/project]", $cred, {
                procedureName => "createTicket",
                stepName => "createTicket"
            });
           
            $batch->attachCredential("\$[/plugins/$pluginName/project]", $cred, {
                procedureName => "commentOnTicket",
                stepName => "commentOnTicket"
            });
        }
    }
}
</value>
      </property>
      <property>
        <propertyName>version</propertyName>
        <counter>0</counter>
        <description>Version of the EC-Zendesk project

History:
-version 1.3.0
     + Added the 2 new fields: problemScope and problemType

-version 1.2.3
     + removed prefix on comment

- version 1.2.2
    + Fixed Help
    + Added content and image

- version 1.2.1
    + Moved to EC 5.4 environment

- version 1.2.0
    + Added credential configuration deletion
    + Added ec_setup.pl code to move existing credentials

- version 1.1.0
    + Added credential configuration management

- version 1.0.0 
    + initial version created for the Citrix hackathon
</description>
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>1.3.0</value>
      </property>
      <property>
        <propertyName>zendeskURL</propertyName>
        <counter>0</counter>
        <description />
        <expandable>1</expandable>
        <tracked>0</tracked>
        <value>https://electriccloud.zendesk.com/api/v2</value>
      </property>
    <property><propertyName>ec_setup</propertyName><value># promote/demote action
# upgrade action
if ($upgradeAction eq "upgrade") {
    my $query = $commander->newBatch();
    my $newcfg = $query->getProperty(
        "/plugins/$pluginName/project/plugin_cfgs");
    my $oldcfgs = $query->getProperty(
        "/plugins/$otherPluginName/project/plugin_cfgs");
	my $creds = $query->getCredentials("\$[/plugins/$otherPluginName]");

	local $self->{abortOnError} = 0;
    $query->submit();

    # if new plugin does not already have cfgs
    if ($query->findvalue($newcfg,"code") eq "NoSuchProperty") {
        # if old cfg has some cfgs to copy
        if ($query->findvalue($oldcfgs,"code") ne "NoSuchProperty") {
            $batch->clone({
                path => "/plugins/$otherPluginName/project/plugin_cfgs",
                cloneName => "/plugins/$pluginName/project/plugin_cfgs"
            });
        }
    }
	
	# Copy configuration credentials and attach them to the appropriate steps
    my $nodes = $query->find($creds);
    if ($nodes) {
        my @nodes = $nodes->findnodes("credential/credentialName");
        for (@nodes) {
            my $cred = $_->string_value;

            # Clone the credential
            $batch->clone({
                path => "/plugins/$otherPluginName/project/credentials/$cred",
                cloneName => "/plugins/$pluginName/project/credentials/$cred"
            });

            # Make sure the credential has an ACL entry for the new project principal
            my $xpath = $commander->getAclEntry("user", "project: $pluginName", {
                projectName => $otherPluginName,
                credentialName => $cred
            });
            if ($xpath->findvalue("//code") eq "NoSuchAclEntry") {
                $batch->deleteAclEntry("user", "project: $otherPluginName", {
                    projectName => $pluginName,
                    credentialName => $cred
                });
                $batch->createAclEntry("user", "project: $pluginName", {
                    projectName => $pluginName,
                    credentialName => $cred,
                    readPrivilege => "allow",
                    modifyPrivilege => "allow",
                    executePrivilege => "allow",
                    changePermissionsPrivilege => "allow"
                });
            }

           # Attach the credential to the appropriate steps
            $batch->attachCredential("\$[/plugins/$pluginName/project]", $cred, {
                procedureName => "createTicket",
                stepName => "createTicket"
            });
           
            $batch->attachCredential("\$[/plugins/$pluginName/project]", $cred, {
                procedureName => "commentOnTicket",
                stepName => "commentOnTicket"
            });
        }
    }
}


# Data that drives the create step picker registration for this plugin.
my %commentOnTicket = ( 
  label       => "EC-Zendesk - commentOnTicket", 
  procedure   => "commentOnTicket", 
  description => "Comment on an existing  Zendesk Ticket", 
  category    => "Administration" 
);

my %createTicket = ( 
  label       => "EC-Zendesk - createTicket", 
  procedure   => "createTicket", 
  description => "Create a Zendesk Ticket", 
  category    => "Administration" 
);

@::createStepPickerSteps = (\%commentOnTicket, \%createTicket);
</value><expandable>0</expandable></property><property><propertyName>project_version</propertyName><value>1.3.0.136</value></property></propertySheet>
    <procedure>
      <procedureName>commentOnTicket</procedureName>
      <description>Comment on an existing  Zendesk Ticket</description>
      <jobNameTemplate />
      <resourceName />
      <timeLimit />
      <timeLimitUnits>minutes</timeLimitUnits>
      <tracked>0</tracked>
      <workspaceName />
      <propertySheet>
        <tracked>0</tracked>
        <property>
          <propertyName>ec_customEditorData</propertyName>
          <tracked>0</tracked>
          <propertySheet>
            <tracked>0</tracked>
            <property>
              <propertyName>parameters</propertyName>
              <tracked>0</tracked>
              <propertySheet>
                <tracked>0</tracked>
                <property>
                  <propertyName>Title</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>comment</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>credential</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>product</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>options</propertyName>
                      <tracked>0</tracked>
                      <propertySheet>
                        <tracked>0</tracked>
                        <property>
                          <propertyName>option1</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricCommander</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electriccommander</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricFlow</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electricflow</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>list</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>ElectricCommander|ElectricFlow</value>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>2</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketBody</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketDescription</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketNumber</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketSubject</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>zendeskURL</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
              </propertySheet>
            </property>
          </propertySheet>
        </property>
        <property>
          <propertyName>exposeToPlugin</propertyName>
          <counter>0</counter>
          <description />
          <expandable>1</expandable>
          <tracked>0</tracked>
          <value>1</value>
        </property>
      </propertySheet>
      <formalParameter>
        <formalParameterName>comment</formalParameterName>
        <defaultValue />
        <description>The comment you want to add to the ticket</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>textarea</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>credential</formalParameterName>
        <defaultValue />
        <description>Name of the credential to use to log into Zendesk</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketNumber</formalParameterName>
        <defaultValue />
        <description>The Zendesk ticket number to add a comment on</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>commentOnTicket</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

use LWP::UserAgent;
use HTTP::Request::Common;
use JSON;
use MIME::Base64;

#############################################################################
#
# Parameters
#
#############################################################################
my $creds = "$[credential]";
my $comment = "$[comment]";
my $URL   = "$[/myProject/zendeskURL]/tickets/$[ticketNumber].json";

#############################################################################
#
# Global Variables
#
#############################################################################
my $DEBUG=0;

# Retrieve login and password from the credential
my $username= $ec->getFullCredential($creds, {value => "password"})->{responses}->[0]->{credential}->{userName}; 
my $password= $ec->getFullCredential($creds, {value => "userName"})->{responses}->[0]->{credential}->{password};

# Package the data in a data structure matching the expected JSON
my %data =(
	ticket => {
        comment => {
			public => "true",
        	body => "$comment"
        },
    },
);

# Encode the data structure to JSON
my $data = encode_json(\%data);

#
# Create request
#
# Note: the current version of the LWP::UserAGent package does not support the put method
#       therefore we have to use the POST metod from the HTTP::Request::Common package
#       However this package seems to have issue with put request containing data so the trick
#       is to create a POST request with the data and then change it to PUT

#my $req = PUT $URL, Content => $data; #;
my $req = POST($URL, 'Content-Type' => 'application/json', 'Content' => $data);
printf("Req: %s\n", $req->as_string);

$req->authorization_basic($username, $password);
$req->method('PUT');

# Create a user agent and make the request
my $ua = LWP::UserAgent->new(ssl_opts =>{ verify_hostname => 0 });

my $response = $ua->request($req);

# Check for HTTP error codes
die 'http status: ' . $response->code . '  ' . $response->message
    unless ($response->is_success);

# Decode the JSON into a Perl data structure
my $response = decode_json($response->content);
print Dumper($response);


</command>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
    </procedure>
    <procedure>
      <procedureName>createConfiguration</procedureName>
      <description>Created by EC-Admin to manage credential configuration</description>
      <tracked>0</tracked>
      <propertySheet>
        <tracked>0</tracked>
      </propertySheet>
      <formalParameter>
        <formalParameterName>config</formalParameterName>
        <description>Configuration Name</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>credential</formalParameterName>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>credential</type>
      </formalParameter>
      <step>
        <stepName>CreateConfiguration</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#########################
## createcfg.pl
#########################

use ElectricCommander;
use ElectricCommander::PropDB;

use constant {
    SUCCESS => 0,
    ERROR   => 1,
};

my $opts;

my $PLUGIN_NAME = "EC-Zendesk";

if (!defined $PLUGIN_NAME) {
    print "PLUGIN_NAME must be defined\n";
    exit ERROR;
}

# get an EC object
my $ec = new ElectricCommander();
$ec->abortOnError(0);

# load option list from procedure parameters
my $x = $ec->getJobDetails($ENV{COMMANDER_JOBID});
my $nodeset = $x->find("//actualParameter");
foreach my $node ($nodeset->get_nodelist) {
    my $parm = $node->findvalue("actualParameterName");
    my $val = $node->findvalue("value");
    $opts->{$parm}="$val";
}

if (!defined $opts->{config} || "$opts->{config}" eq "" ) {
    print "config parameter must exist and be non-blank\n";
    exit ERROR;
}

# check to see if a config with this name already exists before we do anything else
my $xpath = $ec->getProperty("/myProject/plugin_cfgs/$opts->{config}");
my $property = $xpath->findvalue("//response/property/propertyName");

if (defined $property &amp;&amp; "$property" ne "") {
    my $errMsg = "A configuration named '$opts->{config}' already exists.";
    $ec->setProperty("/myJob/configError", $errMsg);
    print $errMsg;
    exit ERROR;
}

my $cfg = new ElectricCommander::PropDB($ec,"/myProject/plugin_cfgs");

# add all the options as properties
foreach my $key (keys % {$opts}) {
    if ("$key" eq "config" ) { 
        next;
    }
    $cfg->setCol("$opts->{config}","$key","$opts->{$key}");
}
exit SUCCESS;

</command>
        <description>Create a EC-Zendesk configuration</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <postProcessor>postp</postProcessor>
        <releaseMode>none</releaseMode>
        <shell>ec-perl</shell>
        <timeLimit>5</timeLimit>
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
      <step>
        <stepName>createAndAttachCredential</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>
##########################
# createAndAttachCredential.pl
##########################

use ElectricCommander;

use constant {
	SUCCESS => 0,
	ERROR   => 1,
};

my $ec = new ElectricCommander();
$ec->abortOnError(0);

my $credName = "$[/myJob/config]";
my $xpath = $ec->getFullCredential("credential");
my $userName = $xpath->findvalue("//userName");
my $password = $xpath->findvalue("//password");

# Create credential
my $projName = "$[/myProject/projectName]";

$ec->deleteCredential($projName, $credName);
$xpath = $ec->createCredential($projName, $credName, $userName, $password);
my $errors = $ec->checkAllErrors($xpath);

# Give config the credential real name
my $configPath = "/projects/$projName/plugin_cfgs/$credName";
$xpath = $ec->setProperty($configPath . "/credential", $credName);
$errors .= $ec->checkAllErrors($xpath);

# Give job launcher full permissions on the credential
my $user = "$[/myJob/launchedByUser]";
$xpath = $ec->createAclEntry("user", $user,
    {projectName => $projName,
     credentialName => $credName,
     readPrivilege => allow,
     modifyPrivilege => allow,
     executePrivilege => allow,
     changePermissionsPrivilege => allow});
$errors .= $ec->checkAllErrors($xpath);

## Attach credential to steps that will need it
$xpath = $ec->attachCredential($projName, $credName,
    {procedureName => "createTicket",
     stepName => "createTicket"});
$errors .= $ec->checkAllErrors($xpath);

## Attach credential to steps that will need it
$xpath = $ec->attachCredential($projName, $credName,
    {procedureName => "commentOnTicket",
     stepName => "commentOnTicket"});
$errors .= $ec->checkAllErrors($xpath);


#if errors
    if ("$errors" ne "") {
        # Cleanup the partially created configuration we just created
        $ec->deleteProperty($configPath);
        $ec->deleteCredential($projName, $credName);
        my $errMsg = "Error creating configuration credential: " . $errors;
        $ec->setProperty("/myJob/configError", $errMsg);
        print $errMsg;
        exit ERROR;
    }

</command>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
        <attachedParameters>
          <formalParameterName>credential</formalParameterName>
        </attachedParameters>
      </step>
    </procedure>
    <procedure>
      <procedureName>createTicket</procedureName>
      <description>Create a Zendesk Ticket</description>
      <jobNameTemplate />
      <resourceName />
      <timeLimit />
      <timeLimitUnits>minutes</timeLimitUnits>
      <tracked>0</tracked>
      <workspaceName />
      <propertySheet>
        <tracked>0</tracked>
        <property>
          <propertyName>ec_customEditorData</propertyName>
          <tracked>0</tracked>
          <propertySheet>
            <tracked>0</tracked>
            <property>
              <propertyName>parameters</propertyName>
              <tracked>0</tracked>
              <propertySheet>
                <tracked>0</tracked>
                <property>
                  <propertyName>Title</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>credential</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>problemScope</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>options</propertyName>
                      <tracked>0</tracked>
                      <propertySheet>
                        <tracked>0</tracked>
                        <property>
                          <propertyName>option1</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Test Setup</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>1_test_setup</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>One User</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>2_one_user</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option3</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>One Team</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>3_one_team</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option4</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Some users</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>4_some_users</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option5</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>One Site</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>5_one_site</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option6</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Some teams</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>6_some_teams</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option7</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Some sites</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>7_some_sites</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option8</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Everyone</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>8_everyone</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>8</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>problemType</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>options</propertyName>
                      <tracked>0</tracked>
                      <propertySheet>
                        <tracked>0</tracked>
                        <property>
                          <propertyName>option1</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Enhancement</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>1_enhancement</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Need Assistance</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>2_need_assistance</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option3</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Nuisance</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>3_nuisance</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option4</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Tool Limiting</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>4_tool_limiting</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option5</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Performance</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>5_performance</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option6</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>Blocking</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>6_blocking</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>6</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>product</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>options</propertyName>
                      <tracked>0</tracked>
                      <propertySheet>
                        <tracked>0</tracked>
                        <property>
                          <propertyName>option1</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricCommander</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electriccommander</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <tracked>0</tracked>
                          <propertySheet>
                            <tracked>0</tracked>
                            <property>
                              <propertyName>text</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>ElectricFlow</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <counter>0</counter>
                              <expandable>1</expandable>
                              <tracked>0</tracked>
                              <value>electricflow</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>list</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>ElectricCommander|ElectricFlow</value>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>2</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <counter>0</counter>
                          <expandable>1</expandable>
                          <tracked>0</tracked>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketBody</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketDescription</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketSubject</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>version</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>zendeskURL</propertyName>
                  <tracked>0</tracked>
                  <propertySheet>
                    <tracked>0</tracked>
                    <property>
                      <propertyName>formType</propertyName>
                      <counter>0</counter>
                      <expandable>1</expandable>
                      <tracked>0</tracked>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
              </propertySheet>
            </property>
          </propertySheet>
        </property>
        <property>
          <propertyName>exposeToPlugin</propertyName>
          <counter>0</counter>
          <description />
          <expandable>1</expandable>
          <tracked>0</tracked>
          <value>1</value>
        </property>
      </propertySheet>
      <formalParameter>
        <formalParameterName>credential</formalParameterName>
        <defaultValue />
        <description>Name of the credential to use to log into Zendesk</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>problemScope</formalParameterName>
        <defaultValue>2_one_user</defaultValue>
        <description>Customer Problem Scope</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>select</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>problemType</formalParameterName>
        <defaultValue>2_need_assistance</defaultValue>
        <description>Customer Problem Type</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>select</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>product</formalParameterName>
        <defaultValue>electriccommander</defaultValue>
        <description>The name of the product for which you want to open a ticket</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>select</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketDescription</formalParameterName>
        <defaultValue />
        <description>The full description of your issue to add to your ticket</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>textarea</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketSubject</formalParameterName>
        <defaultValue />
        <description>The subject of your ticket</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>version</formalParameterName>
        <defaultValue />
        <description>Product version</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>createTicket</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

use LWP::UserAgent;
use JSON;
use MIME::Base64;

#############################################################################
#
# Parameters
#
#############################################################################
my $creds   = "$[credential]";
my $title   = "$[ticketSubject]";
my $body    = "$[ticketDescription]";
my $URL     = "$[/myProject/zendeskURL]/tickets.json";
my $product = "$[product]";
my $version = "$[version]";
my $pbScope = "$[problemScope]";
my $pbType  = "$[problemType]";
#############################################################################
#
# Global Variables
#
#############################################################################
# my $DEBUG=1;


# Retrieve login and password from the credential
my $username= $ec->getFullCredential($creds, {value => "password"})->{responses}->[0]->{credential}->{userName}; 
my $password= $ec->getFullCredential($creds, {value => "userName"})->{responses}->[0]->{credential}->{password};

# Package the data in a data structure matching the expected JSON
my %data =(
	ticket => {
		subject => $title,
        comment => {
        	body => "Ticket created by $[/myParent/projectName]\n\n$body"
        },
        custom_fields => [
                    {'id' => 108886, 'value' => $product},		# Product custome field
                    {"id" => 112789, 'value' => "email"},		# Issue initiation
                    {"id" => 109953, 'value' => $version},		# product version
                    {"id" => 24209853, 'value' => $pbType},		# problem type
                    {"id" => 24250276, 'value' => $pbScope},	# problem scope                  
                  ],
    },
);

# Encode the data structure to JSON
my $data = encode_json(\%data);

#
# Create request
#
my $credentials = encode_base64("$username:$password");

# Create a user agent and make the request
my $ua = LWP::UserAgent->new(ssl_opts =>{ verify_hostname => 0 });
my $response = $ua->post($URL, 
						 'Content' => $data,
                         'Content-Type' => 'application/json',
                         'Authorization' => "Basic $credentials");

# Check for HTTP error codes
die 'http status: ' . $response->code . '  ' . $response->message
    unless ($response->is_success);

# Decode the JSON into a Perl data structure
my $response = decode_json($response->content);
print Dumper($response);
my $ticketId=$response->{audit}->{ticket_id};
$ec->setProperty("/myJob/zendesk/ticketId", $ticketId);
$ec->setProperty("summary", "Zendesk ticket created: $ticketId");


</command>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
    </procedure>
    <procedure>
      <procedureName>DeleteConfiguration</procedureName>
      <description>Created by EC-Admin to manage credential configuration</description>
      <tracked>0</tracked>
      <propertySheet>
        <tracked>0</tracked>
      </propertySheet>
      <formalParameter>
        <formalParameterName>config</formalParameterName>
        <description>Configuration Name</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <tracked>0</tracked>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>DeleteConfiguration</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>##########################
# deletecfg.pl
##########################

use ElectricCommander;
use ElectricCommander::PropDB;

use constant {
	SUCCESS => 0,
	ERROR   => 1,
};

my $opts;

my $PLUGIN_NAME = "EC-Zendesk";
my $projName = "$[/myProject/projectName]";

if (!defined $PLUGIN_NAME) {
    print "PLUGIN_NAME must be defined\n";
    exit ERROR;
}

# get an EC object
my $ec = new ElectricCommander();
$ec->abortOnError(0);

my $opts;
$opts->{config} = "$[config]";

if (!defined $opts->{config} || "$opts->{config}" eq "" ) {
    print "config parameter must exist and be non-blank\n";
    exit ERROR;
}

# check to see if a config with this name already exists before we do anything else
my $xpath = $ec->getProperty("/myProject/plugin_cfgs/$opts->{config}");
my $property = $xpath->findvalue("//response/property/propertyName");

if (!defined $property || "$property" eq "") {
    my $errMsg = "Error: A configuration named '$opts->{config}' does not exist.";
    $ec->setProperty("/myJob/configError", $errMsg);
    print $errMsg;
    exit ERROR;
}

$ec->deleteProperty("/myProject/plugin_cfgs/$opts->{config}");
$ec->deleteCredential($projName, $opts->{config});
exit SUCCESS;

</command>
        <description>Delete a EC-Zendesk configuration</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <postProcessor>postp</postProcessor>
        <releaseMode>none</releaseMode>
        <shell>ec-perl</shell>
        <timeLimit>5</timeLimit>
        <timeLimitUnits>minutes</timeLimitUnits>
        <tracked>0</tracked>
        <propertySheet>
          <tracked>0</tracked>
        </propertySheet>
      </step>
    </procedure>
  </project>
</exportedData>