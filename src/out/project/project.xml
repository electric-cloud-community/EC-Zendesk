<exportedData xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="commander.xsd" version="61" buildLabel="build_4.2_77824_2014.09.27_02:09:10" buildVersion="4.2.6.77824" passkey="a30cbf89cfdae202c5227ce40fe867512295566d">
  <exportPath>/projects/EC-Zendesk</exportPath>
  <project>
    <projectName>EC-Zendesk</projectName>
    <description>&lt;html>
Plugin to interact with Zendesk. Originally developed for the &lt;a html="http://citrixapps.challengepost.com/submissions">Citrix Hackathon&lt;/a>.&lt;br/>
Nikhil and Laurent won "&lt;b>Best in Show&lt;/b>" at the Citrix Synergy 2015 conference for this project.&lt;/html></description>
    <resourceName />
    <workspaceName />
    <propertySheet>
      <property>
        <propertyName>ui_forms</propertyName>
        <propertySheet>
          <property>
            <propertyName>createConfigForm</propertyName>
            <expandable>1</expandable>
            <value>&lt;editor>
    &lt;formElement>
        &lt;type>entry&lt;/type>
        &lt;label>Configuration Name:&lt;/label>
        &lt;property>config&lt;/property>
        &lt;value>&lt;/value>
        &lt;required>1&lt;/required>
    &lt;/formElement>
    &lt;formElement>
        &lt;type>credential&lt;/type>
        &lt;label>Login as:&lt;/label>
        &lt;property>credential&lt;/property>
        &lt;value>&lt;/value>
        &lt;required>0&lt;/required>
    &lt;/formElement>
&lt;/editor></value>
          </property>
          <property>
            <propertyName>editConfigForm</propertyName>
            <expandable>1</expandable>
            <value>&lt;editor>
        &lt;formElement>
        &lt;type>credential&lt;/type>
        &lt;label>Login as:&lt;/label>
        &lt;property>credential&lt;/property>
        &lt;value>&lt;/value>
        &lt;required>0&lt;/required>
    &lt;/formElement>
&lt;/editor></value>
          </property>
        </propertySheet>
      </property>
      <property>
        <propertyName>configure</propertyName>
        <description />
        <expandable>1</expandable>
        <value>1</value>
      </property>
      <property>
        <propertyName>ec_visibility</propertyName>
        <expandable>1</expandable>
        <value>pickListOnly</value>
      </property>
      <property>
        <propertyName>help</propertyName>
        <description />
        <expandable>1</expandable>
        <value>&lt;!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

&lt;html xmlns="http://www.w3.org/1999/xhtml">
&lt;head>
    &lt;meta content="text/html; charset=us-ascii" http-equiv="content-type" />
    &lt;title>EC-Zendesk Plugin&lt;/title>
    &lt;link rel="stylesheet" href= "../../plugins/EC-Zendesk-1.0.0.80/pluginhelp.css" type="text/css" media= "screen" />
&lt;/head>

&lt;body>
    &lt;div class="help">
        &lt;h1>EC-Zendesk&lt;/h1>
&lt;p>Plugin Version 1.0.0.80&lt;/p>
        &lt;hr style="margin-left: -10px; margin-top: 10px; height: 1px; width: 100%; color: #5981BD;" noshade="noshade" />

        &lt;p>EC-Zendesk is a collection of procedures to help you
interact with Zendesk.&lt;/p>

&lt;/body>
&lt;/html></value>
      </property>
      <property>
        <propertyName>pluginBuildNumber</propertyName>
        <expandable>1</expandable>
        <value>80</value>
      </property>
      <property>
        <propertyName>promoteAction</propertyName>
        <description>Upon promotion, copy the current credential and attach them to the steps</description>
        <expandable>0</expandable>
        <value>if ($upgradeAction eq "upgrade") {
    my $query   = $commander->newBatch();
    my $creds   = $query->getCredentials("\$[/plugins/$otherPluginName]");

    local $self->{abortOnError} = 0;
    $query->submit();


    # Copy configuration credentials and attach them to the appropriate steps
    my @nodes = $query->findnodes('credential');
        for (@nodes) {
            my $cred = $_->string_value;

            # Clone the credential
            $batch->clone(
                          {
                            path      => "/plugins/$otherPluginName/project/credentials/$cred",
                            cloneName => "/plugins/$pluginName/project/credentials/$cred"
                          }
                         );

            # Make sure the credential has an ACL entry for the new project principal
            my $xpath = $commander->getAclEntry(
                                                "user",
                                                "project: $pluginName",
                                                {
                                                   projectName    => $otherPluginName,
                                                   credentialName => $cred
                                                }
                                               );
            if ($xpath->findvalue('//code') eq 'NoSuchAclEntry') {
                $batch->deleteAclEntry(
                                       "user",
                                       "project: $otherPluginName",
                                       {
                                          projectName    => $pluginName,
                                          credentialName => $cred
                                       }
                                      );
                $batch->createAclEntry(
                                       "user",
                                       "project: $pluginName",
                                       {
                                          projectName                => $pluginName,
                                          credentialName             => $cred,
                                          readPrivilege              => "allow",
                                          modifyPrivilege            => "allow",
                                          executePrivilege           => "allow",
                                          changePermissionsPrivilege => "allow"
                                       }
                                      );
            }

            # Attach the credential to the appropriate steps
            $batch->attachCredential(
                                     "\$[/plugins/$pluginName/project]",
                                     $cred,
                                     {
                                        procedureName => 'commentOnTicket',
                                        stepName      => 'commentTicket'
                                     }
                                    );
            $batch->attachCredential(
                                     "\$[/plugins/$pluginName/project]",
                                     $cred,
                                     {
                                        procedureName => 'createTicket',
                                        stepName      => 'openTicket'
                                     }
                                    );
        }
    }
}

</value>
      </property>
      <property>
        <propertyName>version</propertyName>
        <description>Version of the EC-Zendesk project

History:
- version 1.0.0 initial version created for the Citrix hackathon
</description>
        <expandable>1</expandable>
        <value>1.0.0</value>
      </property>
      <property>
        <propertyName>zendeskURL</propertyName>
        <description />
        <expandable>1</expandable>
        <value>https://electriccloud.zendesk.com/api/v2</value>
      </property>
    <property><propertyName>ec_setup</propertyName><value># promote/demote action
if ($upgradeAction eq "upgrade") {
    my $query   = $commander->newBatch();
    my $creds   = $query->getCredentials("\$[/plugins/$otherPluginName]");

    local $self->{abortOnError} = 0;
    $query->submit();


    # Copy configuration credentials and attach them to the appropriate steps
    my @nodes = $query->findnodes('credential');
        for (@nodes) {
            my $cred = $_->string_value;

            # Clone the credential
            $batch->clone(
                          {
                            path      => "/plugins/$otherPluginName/project/credentials/$cred",
                            cloneName => "/plugins/$pluginName/project/credentials/$cred"
                          }
                         );

            # Make sure the credential has an ACL entry for the new project principal
            my $xpath = $commander->getAclEntry(
                                                "user",
                                                "project: $pluginName",
                                                {
                                                   projectName    => $otherPluginName,
                                                   credentialName => $cred
                                                }
                                               );
            if ($xpath->findvalue('//code') eq 'NoSuchAclEntry') {
                $batch->deleteAclEntry(
                                       "user",
                                       "project: $otherPluginName",
                                       {
                                          projectName    => $pluginName,
                                          credentialName => $cred
                                       }
                                      );
                $batch->createAclEntry(
                                       "user",
                                       "project: $pluginName",
                                       {
                                          projectName                => $pluginName,
                                          credentialName             => $cred,
                                          readPrivilege              => "allow",
                                          modifyPrivilege            => "allow",
                                          executePrivilege           => "allow",
                                          changePermissionsPrivilege => "allow"
                                       }
                                      );
            }

            # Attach the credential to the appropriate steps
            $batch->attachCredential(
                                     "\$[/plugins/$pluginName/project]",
                                     $cred,
                                     {
                                        procedureName => 'commentOnTicket',
                                        stepName      => 'commentTicket'
                                     }
                                    );
            $batch->attachCredential(
                                     "\$[/plugins/$pluginName/project]",
                                     $cred,
                                     {
                                        procedureName => 'createTicket',
                                        stepName      => 'openTicket'
                                     }
                                    );
        }
    }
}



# Data that drives the create step picker registration for this plugin.
my %commentOnTicket = ( 
  label       => "EC-Zendesk - commentOnTicket", 
  procedure   => "commentOnTicket", 
  description => "Comment on an existing  Zendesk Ticket", 
  category    => "Administration" 
);

my %createTicket = ( 
  label       => "EC-Zendesk - createTicket", 
  procedure   => "createTicket", 
  description => "Create a Zendesk Ticket", 
  category    => "Administration" 
);

@::createStepPickerSteps = (\%commentOnTicket, \%createTicket);
</value></property><property><propertyName>project_version</propertyName><value>1.0.0.80</value></property></propertySheet>
    <procedure>
      <procedureName>commentOnTicket</procedureName>
      <description>Comment on an existing  Zendesk Ticket</description>
      <jobNameTemplate />
      <resourceName />
      <timeLimit />
      <timeLimitUnits>minutes</timeLimitUnits>
      <workspaceName />
      <propertySheet>
        <property>
          <propertyName>ec_customEditorData</propertyName>
          <propertySheet>
            <property>
              <propertyName>parameters</propertyName>
              <propertySheet>
                <property>
                  <propertyName>Title</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>comment</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>credential</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>product</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>options</propertyName>
                      <propertySheet>
                        <property>
                          <propertyName>option1</propertyName>
                          <propertySheet>
                            <property>
                              <propertyName>text</propertyName>
                              <expandable>1</expandable>
                              <value>ElectricCommander</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <expandable>1</expandable>
                              <value>electriccommander</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <propertySheet>
                            <property>
                              <propertyName>text</propertyName>
                              <expandable>1</expandable>
                              <value>ElectricFlow</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <expandable>1</expandable>
                              <value>electricflow</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>list</propertyName>
                          <expandable>1</expandable>
                          <value>ElectricCommander|ElectricFlow</value>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <expandable>1</expandable>
                          <value>2</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <expandable>1</expandable>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketBody</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketDescription</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketNumber</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketSubject</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>zendeskURL</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
              </propertySheet>
            </property>
          </propertySheet>
        </property>
        <property>
          <propertyName>exposeToPlugin</propertyName>
          <description />
          <expandable>1</expandable>
          <value>1</value>
        </property>
      </propertySheet>
      <formalParameter>
        <formalParameterName>comment</formalParameterName>
        <defaultValue />
        <description>The comment you want to add to the ticket</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <type>textarea</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>credential</formalParameterName>
        <defaultValue>zendesk</defaultValue>
        <description />
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketNumber</formalParameterName>
        <defaultValue />
        <description>The Zendesk ticket number to add a comment on</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>commentOnTicket</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

use LWP::UserAgent;
use HTTP::Request::Common;
use JSON;
use MIME::Base64;

#############################################################################
#
# Parameters
#
#############################################################################
my $creds = "$[credential]";
my $comment = "$[comment]";
my $URL   = "$[/myProject/zendeskURL]/tickets/$[ticketNumber].json";

#############################################################################
#
# Global Variables
#
#############################################################################
my $DEBUG=0;

# Retrieve login and password from the credential
my $username= $ec->getFullCredential($creds, {value => "password"})->{responses}->[0]->{credential}->{userName}; 
my $password= $ec->getFullCredential($creds, {value => "userName"})->{responses}->[0]->{credential}->{password};

# Package the data in a data structure matching the expected JSON
my %data =(
	ticket => {
        comment => {
			public => "true",
        	body => "Comment added by $[/myProject/projectName]\n\n$comment"
        },
    },
);

# Encode the data structure to JSON
my $data = encode_json(\%data);

#
# Create request
#
# Note: the current version of the LWP::UserAGent package does not support the put method
#       therefore we have to use the POST metod from the HTTP::Request::Common package
#       However this package seems to have issue with put request containing data so the trick
#       is to create a POST request with the data and then chenge it to PUT

#my $req = PUT $URL, Content => $data; #;
my $req = POST($URL, 'Content-Type' => 'application/json', 'Content' => $data);
printf("Req: %s\n", $req->as_string);

$req->authorization_basic($username, $password);
$req->method('PUT');

# Create a user agent and make the request
my $ua = LWP::UserAgent->new(ssl_opts =>{ verify_hostname => 0 });

my $response = $ua->request($req);

# Check for HTTP error codes
die 'http status: ' . $response->code . '  ' . $response->message
    unless ($response->is_success);

# Decode the JSON into a Perl data structure
my $response = decode_json($response->content);
print Dumper($response);


</command>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
        </propertySheet>
      </step>
    </procedure>
    <procedure>
      <procedureName>createConfiguration</procedureName>
      <description>Created by EC-Admin to manage credential configuration</description>
      <propertySheet>
      </propertySheet>
      <formalParameter>
        <formalParameterName>config</formalParameterName>
        <description>Configuration Name</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>credential</formalParameterName>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <type>credential</type>
      </formalParameter>
      <step>
        <stepName>CreateConfiguration</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#########################
## createcfg.pl
#########################

use ElectricCommander;
use ElectricCommander::PropDB;

use constant {
    SUCCESS => 0,
    ERROR   => 1,
};

my $opts;

my $PLUGIN_NAME = "EC-Zendesk";

if (!defined $PLUGIN_NAME) {
    print "PLUGIN_NAME must be defined\n";
    exit ERROR;
}

# get an EC object
my $ec = new ElectricCommander();
$ec->abortOnError(0);

# load option list from procedure parameters
my $x = $ec->getJobDetails($ENV{COMMANDER_JOBID});
my $nodeset = $x->find("//actualParameter");
foreach my $node ($nodeset->get_nodelist) {
    my $parm = $node->findvalue("actualParameterName");
    my $val = $node->findvalue("value");
    $opts->{$parm}="$val";
}

if (!defined $opts->{config} || "$opts->{config}" eq "" ) {
    print "config parameter must exist and be non-blank\n";
    exit ERROR;
}

# check to see if a config with this name already exists before we do anything else
my $xpath = $ec->getProperty("/myProject/plugin_cfgs/$opts->{config}");
my $property = $xpath->findvalue("//response/property/propertyName");

if (defined $property &amp;&amp; "$property" ne "") {
    my $errMsg = "A configuration named '$opts->{config}' already exists.";
    $ec->setProperty("/myJob/configError", $errMsg);
    print $errMsg;
    exit ERROR;
}

my $cfg = new ElectricCommander::PropDB($ec,"/myProject/plugin_cfgs");

# add all the options as properties
foreach my $key (keys % {$opts}) {
    if ("$key" eq "config" ) { 
        next;
    }
    $cfg->setCol("$opts->{config}","$key","$opts->{$key}");
}
exit SUCCESS;

</command>
        <description>Create a EC-Zendesk configuration</description>
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <parallel>0</parallel>
        <postProcessor>postp</postProcessor>
        <releaseMode>none</releaseMode>
        <shell>ec-perl</shell>
        <timeLimit>5</timeLimit>
        <timeLimitUnits>minutes</timeLimitUnits>
        <propertySheet>
        </propertySheet>
      </step>
      <step>
        <stepName>createAndAttachCredential</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>
##########################
# createAndAttachCredential.pl
##########################

use ElectricCommander;

use constant {
	SUCCESS => 0,
	ERROR   => 1,
};

my $ec = new ElectricCommander();
$ec->abortOnError(0);

my $credName = "$[/myJob/config]";
my $xpath = $ec->getFullCredential("credential");
my $userName = $xpath->findvalue("//userName");
my $password = $xpath->findvalue("//password");

# Create credential
my $projName = "$[/myProject/projectName]";

$ec->deleteCredential($projName, $credName);
$xpath = $ec->createCredential($projName, $credName, $userName, $password);
my $errors = $ec->checkAllErrors($xpath);

# Give config the credential real name
my $configPath = "/projects/$projName/plugin_cfgs/$credName";
$xpath = $ec->setProperty($configPath . "/credential", $credName);
$errors .= $ec->checkAllErrors($xpath);

# Give job launcher full permissions on the credential
my $user = "$[/myJob/launchedByUser]";
$xpath = $ec->createAclEntry("user", $user,
    {projectName => $projName,
     credentialName => $credName,
     readPrivilege => allow,
     modifyPrivilege => allow,
     executePrivilege => allow,
     changePermissionsPrivilege => allow});
$errors .= $ec->checkAllErrors($xpath);

## Attach credential to steps that will need it
$xpath = $ec->attachCredential($projName, $credName,
    {procedureName => "createTicket",
     stepName => "createTicket"});
$errors .= $ec->checkAllErrors($xpath);

## Attach credential to steps that will need it
$xpath = $ec->attachCredential($projName, $credName,
    {procedureName => "commentOnTicket",
     stepName => "commentOnTicket"});
$errors .= $ec->checkAllErrors($xpath);


#if errors
    if ("$errors" ne "") {
        # Cleanup the partially created configuration we just created
        $ec->deleteProperty($configPath);
        $ec->deleteCredential($projName, $credName);
        my $errMsg = "Error creating configuration credential: " . $errors;
        $ec->setProperty("/myJob/configError", $errMsg);
        print $errMsg;
        exit ERROR;
    }

</command>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
        </propertySheet>
        <attachedParameters>
          <formalParameterName>credential</formalParameterName>
        </attachedParameters>
      </step>
    </procedure>
    <procedure>
      <procedureName>createTicket</procedureName>
      <description>Create a Zendesk Ticket</description>
      <jobNameTemplate />
      <resourceName />
      <timeLimit />
      <timeLimitUnits>minutes</timeLimitUnits>
      <workspaceName />
      <propertySheet>
        <property>
          <propertyName>ec_customEditorData</propertyName>
          <propertySheet>
            <property>
              <propertyName>parameters</propertyName>
              <propertySheet>
                <property>
                  <propertyName>Title</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>credential</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>product</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>options</propertyName>
                      <propertySheet>
                        <property>
                          <propertyName>option1</propertyName>
                          <propertySheet>
                            <property>
                              <propertyName>text</propertyName>
                              <expandable>1</expandable>
                              <value>ElectricCommander</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <expandable>1</expandable>
                              <value>electriccommander</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>option2</propertyName>
                          <propertySheet>
                            <property>
                              <propertyName>text</propertyName>
                              <expandable>1</expandable>
                              <value>ElectricFlow</value>
                            </property>
                            <property>
                              <propertyName>value</propertyName>
                              <expandable>1</expandable>
                              <value>electricflow</value>
                            </property>
                          </propertySheet>
                        </property>
                        <property>
                          <propertyName>list</propertyName>
                          <expandable>1</expandable>
                          <value>ElectricCommander|ElectricFlow</value>
                        </property>
                        <property>
                          <propertyName>optionCount</propertyName>
                          <expandable>1</expandable>
                          <value>2</value>
                        </property>
                        <property>
                          <propertyName>type</propertyName>
                          <expandable>1</expandable>
                          <value>list</value>
                        </property>
                      </propertySheet>
                    </property>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketBody</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketDescription</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>ticketSubject</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>version</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
                <property>
                  <propertyName>zendeskURL</propertyName>
                  <propertySheet>
                    <property>
                      <propertyName>formType</propertyName>
                      <expandable>1</expandable>
                      <value>standard</value>
                    </property>
                  </propertySheet>
                </property>
              </propertySheet>
            </property>
          </propertySheet>
        </property>
        <property>
          <propertyName>exposeToPlugin</propertyName>
          <description />
          <expandable>1</expandable>
          <value>1</value>
        </property>
      </propertySheet>
      <formalParameter>
        <formalParameterName>credential</formalParameterName>
        <defaultValue>zendesk</defaultValue>
        <description>Nameof the credential to use.</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>product</formalParameterName>
        <defaultValue>electriccommander</defaultValue>
        <description />
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <type>select</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketDescription</formalParameterName>
        <defaultValue>This ticket has been created automatically by $[/myProject/projectName]:$[/myProcedure/procedureName]</defaultValue>
        <description>The full description of the ticket</description>
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <type>textarea</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>ticketSubject</formalParameterName>
        <defaultValue>TEST ignore - $[/increment /server/counters/$[/myProject/projectName]/jobCounter]</defaultValue>
        <description />
        <expansionDeferred>0</expansionDeferred>
        <required>1</required>
        <type>entry</type>
      </formalParameter>
      <formalParameter>
        <formalParameterName>version</formalParameterName>
        <defaultValue />
        <description>Product version</description>
        <expansionDeferred>0</expansionDeferred>
        <required>0</required>
        <type>entry</type>
      </formalParameter>
      <step>
        <stepName>createTicket</stepName>
        <alwaysRun>0</alwaysRun>
        <broadcast>0</broadcast>
        <command>#############################################################################
#
# Copyright Electric-Cloud 2015
#
#############################################################################
$[/plugins[EC-Admin]project/scripts/perlHeaderJSON]

use LWP::UserAgent;
use JSON;
use MIME::Base64;

#############################################################################
#
# Parameters
#
#############################################################################
my $creds = "$[credential]";
my $title = "$[ticketSubject]";
my $body  = "$[ticketDescription]";
my $URL   = "$[/myProject/zendeskURL]/tickets.json";
my $product="$[product]";
my $version="$[version]";

#############################################################################
#
# Global Variables
#
#############################################################################
# my $DEBUG=1;


# Retrieve login and password from the credential
my $username= $ec->getFullCredential($creds, {value => "password"})->{responses}->[0]->{credential}->{userName}; 
my $password= $ec->getFullCredential($creds, {value => "userName"})->{responses}->[0]->{credential}->{password};

# Package the data in a data structure matching the expected JSON
my %data =(
	ticket => {
		subject => $title,
        comment => {
        	body => "Ticket created by $[/myParent/projectName]\n\n$body"
        },
        custom_fields => [
                    {'id' => 108886, 'value' => $product},		# Product custome field
                    {"id" => 112789, 'value' => "email"},		# Issue initiation
                    {"id" => 109953, 'value' => $version},		# product version
                  ],
    },
);

# Encode the data structure to JSON
my $data = encode_json(\%data);

#
# Create request
#
my $credentials = encode_base64("$username:$password");

# Create a user agent and make the request
my $ua = LWP::UserAgent->new(ssl_opts =>{ verify_hostname => 0 });
my $response = $ua->post($URL, 
						 'Content' => $data,
                         'Content-Type' => 'application/json',
                         'Authorization' => "Basic $credentials");

# Check for HTTP error codes
die 'http status: ' . $response->code . '  ' . $response->message
    unless ($response->is_success);

# Decode the JSON into a Perl data structure
my $response = decode_json($response->content);
print Dumper($response);
my $ticketId=$response->{audit}->{ticket_id};
$ec->setProperty("/myJob/zendesk/ticketId", $ticketId);
$ec->setProperty("summary", "Zendesk ticket created: $ticketId");


</command>
        <condition />
        <description />
        <errorHandling>failProcedure</errorHandling>
        <exclusiveMode>none</exclusiveMode>
        <logFileName />
        <parallel>0</parallel>
        <postProcessor />
        <precondition />
        <releaseMode>none</releaseMode>
        <resourceName />
        <shell>ec-perl</shell>
        <timeLimit />
        <timeLimitUnits>minutes</timeLimitUnits>
        <workingDirectory />
        <workspaceName />
        <propertySheet>
        </propertySheet>
      </step>
    </procedure>
  </project>
</exportedData>